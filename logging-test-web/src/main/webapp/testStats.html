<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script>
			var logBaseUrl = "http://localhost:8080/logging-test-web-1.1.2-SNAPSHOT/log";</script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="services/logging/log-init.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
		<script src="http://code.highcharts.com/highcharts.js"></script>
        <style>
			pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
			.string { color: green; }
			.number { color: darkorange; }
			.boolean { color: blue; }
			.null { color: magenta; }
			.key { color: red; }

			ul.dates{
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			.dates li {
				display: inline-block;
				padding: 3px 10px;
				width:  100px;
				text-align: center;
				color: white;
				margin: 5px;
				background-color: darkblue
			}
			.log-tooltip-serie {
				background: black;
				color: white;
				padding: 3px 8px;
			}
        </style>
    </head>
    <body>

		<script>
			var chart, chartDetail;
			Highcharts.setOptions({
				global: {
					useUTC: false
				}
			});
			document.logInfo = {
				hosts: {
					mzbeprod1: "mzbeprod",
					mzbeprod2: "mzbeprod",
					'mezoappprod1.servers.vrt.be': "mezoappprod",
					'mezoappprod2.servers.vrt.be': "mezoappprod"
				},
				statsUrl: "log/stats/overview/",
				knownHost: function (name) {
					return this.hosts[name];
				}
			}


			document.logChart = {
				hosts: {
					displayData: function (data, date) {
						this.chartData = {
							labels: [],
							datasets: [],
							drilldown: {
								series: []
							},
							dataset_map: {}
						};

						data.time.buckets.forEach(function (time, i, array) {
							var chartData = document.logChart.hosts.chartData;
							chartData.labels.push(new Date(time.key_as_string));
							time.hosts.buckets.forEach(function (host, index) {
								host.rel_key = document.logInfo.knownHost(host.key);
								if (!host.rel_key) {
									console.log("skipping host  " + host.key)
									return;
								}

								// Initialize data set
								if (!chartData.dataset_map[host.rel_key ]) {
									chartData.dataset_map[host.rel_key ] = {
										name: host.rel_key,
										data: []
									};
									for (var j = 0; j < array.length; j++) {
										chartData.dataset_map[host.rel_key ].data.push({y: 0, info: [], errors: 0, failures: 0});
									}
									;
									chartData.datasets.push(chartData.dataset_map[host.rel_key]);
								}
								var detailData = chartData.dataset_map[host.rel_key].data[i];
								// Set data in dataset.
								detailData.y += host.doc_count;
								detailData.info.push(host);

								host.Methods.buckets.forEach(function (m) {
									m.Status.buckets.forEach(function (s) {
										if (s.key === 'ERROR') {
											detailData.errors += s.doc_count;
										}
										if (s.key === 'FAIL') {
											detailData.failures += s.doc_count;
										}
									});
								});
								if (detailData.failures > 0) {
									detailData.color = "orange";
								}
								if (detailData.errors > 0) {
									detailData.color = "red";
								}

							})
						});

						chart = new Highcharts.Chart({
							chart: {
								renderTo: 'container',
								type: 'column'
							},
							title: {
								text: ' [' + date + '] Calls / Hour'
							},
							xAxis: {
								categories: document.logChart.hosts.chartData.labels,
								type: 'datetime',
								labels: {
									format: '{value:%H:%M}',
								}

							},
							yAxis: {
								min: 0,
								title: {
									text: '#Calls'
								},
								stackLabels: {
									enabled: true,
									style: {
										fontWeight: 'bold',
										color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
									}
								}
							},
							legend: {
								align: 'right',
								x: -30,
								verticalAlign: 'top',
								y: 25,
								floating: true,
								backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
								borderColor: '#CCC',
								borderWidth: 1,
								shadow: false
							},
							tooltip: {
								formatter: function () {
									var rtnValue = '';
									rtnValue += '<table class="log-tooltip">';
									rtnValue += '<tr><th><span class="log-tooltip-serie">' + Highcharts.dateFormat('%H:%M', this.x) + '</span></th><th>' + this.series.name + '</th><td>' + this.y + '</td></tr>';
									if (this.point.info) {
										rtnValue += '<tr><td colspan="3"><hr></td></tr>';
										var data = this.point.info;
										data.forEach(function (detail) {
											rtnValue += '<tr><td colspan="2">' + detail.key + '</td><td>' + detail.doc_count + '</td></tr>';
										});
										rtnValue += '<tr><td colspan="3"><hr></td></tr>';
										rtnValue += '<tr><td colspan="2">FAIL</td><td>' + this.point.failures + '</td></tr>';
										rtnValue += '<tr><td colspan="2">ERROR</td><td>' + this.point.errors + '</td></tr>';

									}
									rtnValue += '</table>';
									return rtnValue;
								},
								useHTML: true
							},
							plotOptions: {
								column: {
									stacking: 'normal',
									dataLabels: {
										enabled: true,
										color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
										style: {
											textShadow: '0 0 3px black'
										}
									},
									point: {
										events: {
											click: function () {
												console.log(this);
											}
										}
									}
								}
							},
							series: document.logChart.hosts.chartData.datasets

						});


					}
				}
			}
			function loadDate(date) {
				$.get(document.logInfo.statsUrl + date, null, function (data) {
					document.logChart.hosts.displayData(data.agg, date);
				})
			}


		</script>
		<h1>Graph</h1>
		<ul class="dates">
			<li onclick="loadDate('2015-08-25')">2015-08-25</li>
			<li onclick="loadDate('2015-08-26')">2015-08-26</li>
			<li onclick="loadDate('2015-08-27')">2015-08-27</li>
			<li onclick="loadDate('2015-08-28')">2015-08-28</li>
		</ul>
		<div id="container"></div>
		<div id="container_details"></div>
    </body>
</html>
