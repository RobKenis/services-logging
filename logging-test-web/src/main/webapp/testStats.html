<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script>
			var logBaseUrl = "http://localhost:8080/logging-test-web-1.1.2-SNAPSHOT/log";</script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="services/logging/log-init.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
		<script src="http://code.highcharts.com/highcharts.js"></script>
        <style>
			pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
			.string { color: green; }
			.number { color: darkorange; }
			.boolean { color: blue; }
			.null { color: magenta; }
			.key { color: red; }

			ul.dates{
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			.dates li {
				display: inline-block;
				padding: 3px 10px;
				width:  100px;
				text-align: center;
				color: white;
				margin: 5px;
				background-color: darkblue
			}
			.log-tooltip-serie {
				background: black;
				color: white;
				padding: 3px 8px;
			}

			#logLoading {
				display: none;
				background: black;
				opacity: 0.4;
				position: fixed;
				top: 0px;
				bottom: 0px;
				left: 0px;
				right: 0px;
			}
        </style>
    </head>
    <body>

		<script>
			var chart, chartDetail;
			Highcharts.setOptions({
				global: {
					useUTC: false
				}
			});
			document.logInfo = {
				hosts: {
					mzbeprod1: "mzbeprod",
					mzbeprod2: "mzbeprod",
					'mezoappprod1.servers.vrt.be': "mezoappprod",
					'mezoappprod2.servers.vrt.be': "mezoappprod"
				},
				statsUrl: "log/stats/",
				knownHost: function (name, info) {
					if (info && info.hosts) {
						return info.hosts[name];
					}
					return name;
				}
			}

			document.logDisplay = {
				dateBar: {
					display: function (divId) {
						var dateBar = $("<ul class='dates'/>");
						$("#" + divId).append(dateBar);
						var date = new Date();
						for (var i = 0; i < 10; i++) {
							var fDate = this.formatDate(date);
							$("<li onclick=\"loadDate('" + fDate + "')\">" + fDate + "</li>").appendTo(dateBar);
							date.setTime(date.getTime() - 1000 * 60 * 60 * 24)
						}


					},
					formatDate: function (date) {
						var year = date.getFullYear();
						var month = date.getMonth() + 1;
						var day = date.getDate();
						return year + "-" + (month < 10 ? "0" : "") + month + "-" + (day < 10 ? "0" : "") + day;
					}
				}
			}
			document.logChart = {
				hosts: {
					displayData: function (data, info) {
						this.chartData = {
							labels: [],
							datasets: [],
							drilldown: {
								series: []
							},
							dataset_map: {}
						};

						data.time.buckets.forEach(function (time, i, array) {
							var chartData = document.logChart.hosts.chartData;
							chartData.labels.push(new Date(time.key_as_string));
							time.hosts.buckets.forEach(function (host, index) {
								host.rel_key = document.logInfo.knownHost(host.key, info);
								if (!host.rel_key) {
									return;
								}

								// Initialize data set
								if (!chartData.dataset_map[host.rel_key ]) {
									chartData.dataset_map[host.rel_key ] = {
										name: host.rel_key,
										data: []
									};
									for (var j = 0; j < array.length; j++) {
										chartData.dataset_map[host.rel_key ].data.push({y: 0, info: [], errors: 0, failures: 0});
									}
									;
									chartData.datasets.push(chartData.dataset_map[host.rel_key]);
								}
								var detailData = chartData.dataset_map[host.rel_key].data[i];
								// Set data in dataset.
								detailData.y += host.doc_count;
								host.chart_info = info;
								detailData.info.push(host);

								host.methods.buckets.forEach(function (m) {
									m.Status.buckets.forEach(function (s) {
										if (s.key === 'ERROR') {
											detailData.errors += s.doc_count;
										}
										if (s.key === 'FAIL') {
											detailData.failures += s.doc_count;
										}
									});
								});
								if (detailData.failures > 0) {
									detailData.color = "orange";
								}
								if (detailData.errors > 0) {
									detailData.color = "red";
								}

							})
						});
						if ($("#" + info.location.id).length === 0) {
							$("#" + info.location.parent).append("<div id='" + info.location.id + "'/>");
							$("#" + info.location.parent).append("<div id='" + info.location.id + "_details'/>");
						}

						chart = new Highcharts.Chart({
							chart: {
								renderTo: info.location.id,
								type: 'column'
							},
							title: {
								text: info.location.id + ' -  [' + info.date + '] Calls / Hour'
							},
							xAxis: {
								categories: document.logChart.hosts.chartData.labels,
								type: 'datetime',
								labels: {
									format: '{value:%H:%M}',
								}

							},
							yAxis: {
								min: 0,
								title: {
									text: '#Calls'
								},
								stackLabels: {
									enabled: true,
									style: {
										fontWeight: 'bold',
										color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
									}
								}
							},
							legend: {
								align: 'right',
								x: -30,
								verticalAlign: 'top',
								y: 25,
								floating: true,
								backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
								borderColor: '#CCC',
								borderWidth: 1,
								shadow: false
							},
							tooltip: {
								formatter: function () {
									var rtnValue = '';
									rtnValue += '<table class="log-tooltip">';
									rtnValue += '<tr><th><span class="log-tooltip-serie">' + Highcharts.dateFormat('%H:%M', this.x) + '</span></th><th>' + this.series.name + '</th><td>' + this.y + '</td></tr>';
									if (this.point.info) {
										rtnValue += '<tr><td colspan="3"><hr></td></tr>';
										var data = this.point.info;
										data.forEach(function (detail) {
											rtnValue += '<tr><td colspan="2">' + detail.key + '</td><td>' + detail.doc_count + '</td></tr>';
										});
										if (this.point.failures + this.point.errors > 0) {
											rtnValue += '<tr><td colspan="3"><hr></td></tr>';
										}
										if (this.point.failures > 0) {
											rtnValue += '<tr><td colspan="2">FAIL</td><td>' + this.point.failures + '</td></tr>';
										}
										if (this.point.errors > 0) {
											rtnValue += '<tr><td colspan="2">ERROR</td><td>' + this.point.errors + '</td></tr>';
										}

									}
									rtnValue += '</table>';
									return rtnValue;
								},
								useHTML: true
							},
							plotOptions: {
								column: {
									stacking: 'normal',
									dataLabels: {
										enabled: true,
										color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
										style: {
											textShadow: '0 0 3px black'
										}
									},
									point: {
										events: {
											click: function () {
												document.logChart.hosts.detailPieChart(this.info);
											}
										}
									}
								}
							},
							series: document.logChart.hosts.chartData.datasets

						});
					},
					detailPieChart: function (info) {
						if (!(info && info[0])) {
							return;
						}
						var chart_info = info[0].chart_info;
						var callMethods = {};
						info.forEach(function (host) {
							console.log(host);
							host.methods.buckets.forEach(function (method) {
								if (callMethods[method.key]) {
									callMethods[method.key].count += method.doc_count;
								} else {
									callMethods[method.key] = {
										key: method.key,
										count: method.doc_count
									};
								}
							})
						});
						var data = []
						for (var property in callMethods) {
							var method = callMethods[property];
							if (method.count) {
								data.push({y: method.count, name: method.key})

							}
						}
						$("#" + chart_info.location.id + "_details").empty();
						$("#" + chart_info.location.id + "_details").append("<div id='" + chart_info.location.id + "_detail_calls' >")
						$("#" + chart_info.location.id + "_detail_calls").highcharts({
							chart: {
								plotBackgroundColor: null,
								plotBorderWidth: null,
								plotShadow: false,
								type: 'pie'
							},
							title: {
								text: 'Calls'
							},
							tooltip: {
								pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
							},
							plotOptions: {
								pie: {
									allowPointSelect: true,
									showInLegend: true,
									cursor: 'pointer',
									dataLabels: {
										enabled: true,
										format: '<b>{point.name}</b>: {point.y} ({point.percentage:.1f}%)',
										style: {
											color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
										}
									}
								}
							},
							legend: {
								layout: "vertical",
								align: "right",
								verticalAlign: 'middle',
								labelFormatter: function () {
									return '<b>' + this.name + '</b>: ' + this.y
								},
							},
							series: [{
									name: "Calls",
									colorByPoint: true,
									data: data
								}]
						});
						$("#" + chart_info.location.id + "_details").append("<div id='" + chart_info.location.id + "_detail_table' >")

//						$("#" + chart_info.location.id + "_detail_table").append()

					}
				}
			}
			function loadDate(date) {

				$("#container").empty();
				$("#logLoading").show();
				$("#container").append("<div id='logStatsErrors' />");
				$("#container").append("<hr>");
				$.get(document.logInfo.statsUrl + "errors/" + date, null, function (data) {
					$("#logStatsErrors").append("<table style='width: 100%'><tbody></tbody></table>");
					$("#logStatsErrors tbody").append("<tr><th>Time</th><th>FlowId</th><th>Call</th><th>ErrorMessage</th></tr>");

					data.statshits.hits.forEach(function (hit) {
						var source = hit._source;
						console.log(hit);
						$("#logStatsErrors tbody").append("<tr/>");
						$("#logStatsErrors tbody tr:last").append("<td>" + Highcharts.dateFormat('%H:%M:%S', source.logDate) + "</td>");
						$("#logStatsErrors tbody tr:last").append("<td>" + source.flowId + "</td>");
						$("#logStatsErrors tbody tr:last").append("<td>" + source.content['[4] AuditLogDto'].method + "</td>");
						$("#logStatsErrors tbody tr:last").append("<td>" + source.content['[4] AuditLogDto'].response.message + "</td>");
					})
				});
				$.get(document.logInfo.statsUrl + "overview/" + date, null, function (data) {
					document.logChart.hosts.displayData(data.agg,
							{
								date: date,
								hosts: {
									mzbeprod1: "mzbeprod",
									mzbeprod2: "mzbeprod"
								},
								location: {
									parent: 'container',
									id: 'mzbeprod'
								}
							}
					);
					document.logChart.hosts.displayData(data.agg,
							{
								date: date,
								hosts: {
									'mezoappprod1.servers.vrt.be': "mezoappprod",
									'mezoappprod2.servers.vrt.be': "mezoappprod"
								},
								location: {
									parent: 'container',
									id: 'mezoappprod'
								}
							}
					);
				}).always(function () {
					$("#logLoading").hide()
				})
			}
			$(function () {
				document.logDisplay.dateBar.display("bar");
			})

		</script>
		<div id="logLoading"><center><img src="services/logging/loading.gif" style="margin: auto; opacity: 1;margin-top: 250px;"/></center></div>
		<h1>Graph</h1>
		<div id="bar"></div>
		<div id="container"></div>
    </body>
</html>
